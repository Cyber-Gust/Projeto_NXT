<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEXT Sports BR - Turbo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* 1. Cores e Tema Light (Preto, Branco, com Destaque Azul) */
    :root{
      --cor-primaria: #000;
      --cor-secundaria: #333;
      --cor-fundo: #fff;
      --cor-fundo-secundario: #F4F4F4;
      --cor-texto: #000;
      --cor-borda: #DDD;
      --cor-destaque: #007bff; /* Azul vibrante para detalhes de ação */
      --ok: #28a745; /* Verde para sucesso */
      --warn: #ffc107; /* Amarelo para alerta */
      --err: #dc3545; /* Vermelho para erro */
    }

    /* Reset e Base */
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Roboto,Arial,sans-serif}
    body{background:var(--cor-fundo-secundario);color:var(--cor-texto);display:flex;min-height:100vh}

    /* Ícones SVG */
    .icon { display: inline-block; width: 1em; height: 1em; stroke-width: 0; stroke: currentColor; fill: currentColor; vertical-align: middle; margin-right: 8px; }

    /* 2. Layout Principal */
    .sidebar{ width:260px;background:var(--cor-primaria);color:var(--cor-fundo);padding:20px 0;display:flex;flex-direction:column; box-shadow:2px 0 5px rgba(0,0,0,.1);position:fixed;inset:0 auto 0 0;transition:transform .3s ease-in-out;z-index:10 }
    .sidebar.collapsed{transform:translateX(-100%)}
    .logo{text-align:center;padding:10px 20px 30px;font-size:1.5em;font-weight:bold}
    .menu-item{padding:15px 20px;cursor:pointer;border-left:5px solid transparent;transition:background .2s,border-left-color .2s; display: flex; align-items: center;}
    .menu-item:hover{background:var(--cor-secundaria)}
    .menu-item.active{background:var(--cor-secundaria);border-left-color:var(--cor-fundo);font-weight:bold}
    
    .main-content{margin-left:260px;flex-grow:1;padding:30px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .header{display:flex;gap:12px;align-items:center;padding-bottom:20px;border-bottom:1px solid var(--cor-borda);margin-bottom:30px}
    .header h1{font-size:2em}
    .burger{display:none;border:1px solid var(--cor-borda);padding:8px 10px;border-radius:6px;background:var(--cor-fundo);cursor:pointer}

    /* 3. Cards e Estrutura */
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:24px}
    .metric-card{background:var(--cor-fundo);padding:18px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.05);border:1px solid var(--cor-borda)}
    .metric-card h3{font-size:.95em;color:var(--cor-secundaria);margin-bottom:6px}
    .metric-card p{font-size:1.6em;font-weight:800;color:var(--cor-primaria)}
    .metric-card .lucro-pos{color: var(--ok);}
    .metric-card .lucro-neg{color: var(--err);}
    .kpi-sub{font-size:.8em;color:var(--cor-secundaria);margin-top:6px}
    .section-container{display:none}
    .section-container.active{display:block}
    .section-box{background:var(--cor-fundo);padding:22px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.05);border:1px solid var(--cor-borda);margin-bottom:22px}
    .section-box h2{margin-bottom:16px;font-size:1.35em;border-bottom:1px solid var(--cor-borda);padding-bottom:10px}
    
    #chartFatAds { max-height: 350px; width: 100%; }
    
    /* 4. Toolbar e Busca */
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 20px;}
    .search{flex:1;min-width:220px; position: relative;}
    .search input{width:100%;padding:10px 10px 10px 35px;border:1px solid var(--cor-borda);border-radius:8px;background:var(--cor-fundo);color:var(--cor-texto)}
    .search::before { content: '🔍'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--cor-secundaria); font-size: 1.1em;}

    /* 5. Tabela (Custos, Influencers) */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{text-align:left;padding:12px;border-bottom:1px solid var(--cor-borda)}
    th{background:var(--cor-fundo-secundario);text-transform:uppercase;font-size:.8em;cursor:pointer;user-select:none;position:relative}
    th.sort-asc::after{content:" ▲";font-weight:normal;color:var(--cor-destaque)}
    th.sort-desc::after{content:" ▼";font-weight:normal;color:var(--cor-destaque)}

    /* 6. Botões e Badges */
    .action-button{background:var(--cor-primaria);color:var(--cor-fundo);padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;transition:background .2s; display: inline-flex; align-items: center; gap: 6px;}
    .action-button:hover{background:var(--cor-secundaria)}
    .btn-secondary{background:var(--cor-destaque);color:var(--cor-fundo)}
    .btn-secondary:hover{background:#0056b3}
    .btn-err{background:var(--err);color:var(--cor-fundo)}
    .btn-err:hover{background:#a71d2a}
    .btn-ghost{background:transparent;border:1px solid var(--cor-borda);color:var(--cor-texto)}
    .btn-ghost:hover{background:var(--cor-fundo-secundario)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.75em;font-weight:bold}
    .badge.ok{background-color:var(--ok);color:var(--cor-fundo)}
    .badge.warn{background-color:var(--warn);color:var(--cor-primaria)}
    .badge.err{background-color:var(--err);color:var(--cor-fundo)}

    /* 7. KANBAN */
    .kanban-board-wrapper { overflow-x: auto; padding-bottom: 15px; }
    .kanban-board { display: flex; gap: 20px; min-width: max-content; }
    .kanban-column { width: 320px; background-color: var(--cor-fundo-secundario); border-radius: 10px; padding: 10px; flex-shrink: 0; }
    .kanban-column header { padding: 10px; border-bottom: 2px solid var(--cor-borda); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .kanban-column h3 { font-size: 1.1em; margin: 0; }
    .kanban-cards { min-height: 200px; padding-bottom: 10px;}
    .kanban-card { background: var(--cor-fundo); border: 1px solid var(--cor-borda); padding: 12px; border-radius: 8px; margin-top: 12px; cursor: grab; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: box-shadow .2s, transform .2s; }
    .kanban-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.12); transform: translateY(-2px); }
    .kanban-card strong { display: block; margin-bottom: 4px; }
    .kanban-card small { color: var(--cor-secundaria); }
    .kanban-card.dragging { opacity: 0.5; transform: rotate(3deg); background: #eef; }
    .kanban-column.drag-over .kanban-cards { background-color: #e0eaff; border-radius: 8px; }
    
    /* 8. Paginação */
    .pagination{display:flex;gap:6px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;align-items:center}
    .pagination button{padding:6px 10px;border:1px solid var(--cor-borda);background:var(--cor-fundo);color:var(--cor-texto);border-radius:6px;cursor:pointer;transition:background .2s}
    .pagination button:hover{background:var(--cor-fundo-secundario)}
    .pagination button.active{background:var(--cor-destaque);color:var(--cor-fundo);border-color:var(--cor-destaque)}
    .pagination .per-page{margin-right:auto}
    .pagination .per-page select{padding:6px;border:1px solid var(--cor-borda);border-radius:6px;background:var(--cor-fundo);color:var(--cor-texto)}

    /* 9. Modal e Formulários */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--cor-fundo);color:var(--cor-texto);border:1px solid var(--cor-borda);border-radius:12px;max-width:720px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--cor-borda)}
    .modal header h3{font-size:1.1rem;color:var(--cor-primaria)}
    .modal .content{padding:18px}
    .modal footer{display:flex;gap:8px;justify-content:flex-end;padding:14px 18px;border-top:1px solid var(--cor-borda)}
    .close-x{cursor:pointer;border:1px solid var(--cor-borda);border-radius:8px;padding:6px 10px;background:var(--cor-fundo);transition:background .2s}
    .close-x:hover{background:var(--cor-fundo-secundario)}
    .progress{height:10px;background:var(--cor-fundo-secundario);border-radius:6px;overflow:hidden;border:1px solid var(--cor-borda)}
    .progress > span{display:block;height:100%;background:var(--cor-destaque);width:0%;transition:width .2s ease-out}

    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: .9em; margin-bottom: 4px; color: var(--cor-secundaria); }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--cor-borda); border-radius: 8px; background: var(--cor-fundo); color: var(--cor-texto); font-size: 1em; }
    
    /* 10. Responsividade */
    @media (max-width: 1024px){
      .burger{display:inline-block}
      .main-content{margin-left:0;padding:20px}
      .sidebar{transform:translateX(-100%)}
      .sidebar.open{transform:translateX(0)}
      .header{flex-direction:column;align-items:flex-start}
      .metrics-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <svg width="0" height="0" style="position:absolute">
    <symbol id="icon-dash" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></symbol>
    <symbol id="icon-pedidos" viewBox="0 0 24 24"><path d="M19 8h-1V3H6v5H5c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-7-3h2v3h-2V5zM7 5h2v3H7V5zm12 15H5V10h14v10z"/></symbol>
    <symbol id="icon-financas" viewBox="0 0 24 24"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.22-1.05-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></symbol>
    <symbol id="icon-rastreio" viewBox="0 0 24 24"><path d="M20.5 3l-16 7.5L10 14l.5 6 3.5-5.5L20.5 3z"/></symbol>
    <symbol id="icon-influencers" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
    <symbol id="icon-sync" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></symbol>
  </svg>

  <aside class="sidebar" id="sidebar">
    <div class="logo">NEXT Sports BR</div>
    <div class="menu">
      <div class="menu-item active" data-target="dash"><svg class="icon"><use href="#icon-"/></svg>Dashboard</div>
      <div class="menu-item" data-target="pedidos"><svg class="icon"><use href="#icon-pedidos"/></svg>Pedidos</div>
      <div class="menu-item" data-target="financas"><svg class="icon"><use href="#icon-financas"/></svg>Finanças</div>
      <div class="menu-item" data-target="rastreio"><svg class="icon"><use href="#icon-rastreio"/></svg>Rastreio</div>
      <div class="menu-item" data-target="influencers"><svg class="icon"><use href="#icon-influencers"/></svg>Influencers</div>
    </div>
  </aside>

  <main class="main-content">
    <div class="topbar">
      <button class="burger" id="burger">☰ Menu</button>
      <div class="muted" style="font-size:.9em">Olá, Admin!</div>
    </div>

    <div class="header">
      <h1 id="page-title"></h1>
      <span class="badge ok">AO VIVO</span>
    </div>

    <section class="section-container active" id="-section">
      <div class="metrics-grid" id="kpi-grid"></div>
      <div class="section-box">
        <h2>Faturamento x ADS (últimos 30 dias)</h2>
        <canvas id="chartFatAds" aria-label="Gráfico de Faturamento versus Ads"></canvas>
        <div class="kpi-sub">Tip: ROAS diário > 2.0 é nossa barra de ouro.</div>
      </div>
    </section>

    <section class="section-container" id="pedidos-section">
        <div class="section-box">
            <h2>Pedidos (Integração Shopify)</h2>
            <div class="toolbar">
              <button class="action-button btn-secondary" id="btnImport"><svg class="icon"><use href="#icon-sync"/></svg>Sincronizar com Shopify</button>
              <div class="search"><input id="search-pedidos" placeholder="Buscar por ID, produto..."/></div>
            </div>
            <div class="kanban-board-wrapper">
                <div id="kanban-board" class="kanban-board"></div>
            </div>
        </div>
    </section>

    <section class="section-container" id="financas-section">
      <div class="section-box">
        <h2>Custos Operacionais</h2>
        <div class="toolbar">
          <button class="action-button" id="btnAdicionarCusto"><svg class="icon"><use href="#icon-plus"/></svg>Adicionar Custo</button>
          <div class="search"><input id="search-custos" placeholder="Filtrar custos por nome/categoria..."/></div>
        </div>
        <table id="tabela-custos">
          <thead>
            <tr>
              <th data-key="nome">Custo</th>
              <th data-key="categoria">Categoria</th>
              <th data-key="valor" data-num>Valor (Mensal)</th>
              <th data-nosort>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody-custos"></tbody>
        </table>
        <p id="total-custos" style="margin-top: 14px; font-weight: bold; text-align: right;"></p>
      </div>
    </section>

    <section class="section-container" id="rastreio-section">
      <div class="section-box">
        <h2>Rastreio de Pedidos (Interno)</h2>
        <div class="toolbar">
          <div class="search"><input id="search-rastreio" placeholder="Filtrar por nome/rastreio/transportadora..."/></div>
        </div>
        <table id="tabela-rastreio-interno">
          <thead>
            <tr>
              <th data-key="nome">Nome Cliente</th>
              <th data-key="rastreio">Rastreio Próprio</th>
              <th data-key="transportadora">Transportadora</th>
              <th data-key="data_chegada">Data Prev. Chegada</th>
              <th data-key="status">Status Atual</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="pag-rastreio"></div>
      </div>
    </section>

    <section class="section-container" id="influencers-section">
      <div class="section-box">
        <h2>Gerenciamento de Influencers</h2>
        <div class="toolbar">
          <div class="search"><input id="search-influ" placeholder="Filtrar por nome/cupom..."/></div>
        </div>
        <table id="tabela-influencers">
          <thead>
            <tr>
              <th data-key="nome">Nome</th>
              <th data-key="tel">Telefone</th>
              <th data-key="cupom">Cupom</th>
              <th data-key="vendas" data-num>Vendas (30d)</th>
              <th data-key="comissao" data-num>Comissão</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="pag-influencers"></div>
      </div>
    </section>
  </main>

  <div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modal-title">
      <header>
        <h3 id="modal-title">Título</h3>
        <button class="close-x" id="modal-close" aria-label="Fechar">✕</button>
      </header>
      <div class="content" id="modal-content"></div>
      <footer id="modal-footer"></footer>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ==========================
    // Utils
    // ==========================
    const brl = (n) => Number(n).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const pct = (n) => `${Number(n).toFixed(1)}%`;
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const fmtBR = (d) => d.toLocaleDateString('pt-BR');
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };

    function toast(msg) {
        openModal('Aviso', `<p style="font-weight:bold">${msg}</p>`, [{ label: 'Ok', variant: 'primary' }]);
    }

    // ==========================
    // Modal Core
    // ==========================
    const overlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const modalFooter = document.getElementById('modal-footer');
    document.getElementById('modal-close').addEventListener('click', closeModal);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    function openModal(title, html, actions = [{ label: 'Fechar', variant: 'ghost', keepOpen: false }]) {
        modalTitle.textContent = title;
        modalContent.innerHTML = html;
        modalFooter.innerHTML = '';
        actions.forEach(a => {
            const btn = document.createElement('button');
            btn.className = 'action-button ' + (a.variant === 'secondary' ? 'btn-secondary' : a.variant === 'ghost' ? 'btn-ghost' : a.variant === 'err' ? 'btn-err' : '');
            btn.textContent = a.label;
            btn.addEventListener('click', () => {
                if (typeof a.onClick === 'function') a.onClick();
                if (!a.keepOpen) closeModal();
            });
            modalFooter.appendChild(btn);
        });
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden', 'true');
    }

    // ==========================
    // Estado (Dados)
    // ==========================
    const baseKPIs = { faturamento: 150450.22, custoProduto: 45135.00, frete: 12890.55, ads: 30500.00 };

    const PRODUTOS = ['Camisa NEXT', 'Tênis Running X', 'Meia Esportiva', 'Jaqueta Tech', 'Short Dry', 'Boné Logo', 'Garrafa Térmica', 'Mochila Training', 'Calça Jogger', 'Caneleira Pro'];
    const STATUS = ['Processando', 'Pago', 'Separando', 'Enviado', 'Em Trânsito', 'Entregue', 'Cancelado'];
    
    // Gera 300 pedidos
    let pedidosMock = Array.from({ length: 300 }, (_, i) => {
        const id = (1001 + i).toString();
        const produto = pick(PRODUTOS);
        const status = pick(STATUS);
        const rastreio = `NEXT${rand(10000, 99999)}${pick(['BR', 'EX', 'PR'])}`;
        const enviado = ['Enviado', 'Em Trânsito', 'Entregue'].includes(status);
        return { id, produto, status, rastreio, enviado };
    });

    // Custos (com ID único)
    let custosMock = [
        {id: 1, nome:'Custo Operacional Content/Mkt',categoria:'Marketing',valor:5000},
        {id: 2, nome:'Salários Colaboradores',categoria:'RH',valor:15000},
        {id: 3, nome:'Plataformas (Shopify, ERP, etc)',categoria:'Tecnologia',valor:1500},
        {id: 4, nome:'Taxas de Cartão',categoria:'Financeiro',valor:1200},
        {id: 5, nome:'Aluguel Loja/Depósito',categoria:'Admin',valor:9000},
        {id: 6, nome:'Energia/Água/Internet',categoria:'Utilidades',valor:2200},
        {id: 7, nome:'Embalagens',categoria:'Logística',valor:1800},
        {id: 8, nome:'Impostos',categoria:'Fiscal',valor:12500},
        {id: 9, nome:'Publicidade ADS',categoria:'Marketing',valor:30500},
        {id: 10, nome:'Contabilidade',categoria:'Financeiro',valor:1800},
    ];
    let nextCustoId = 11;

    // Outros dados (Rastreio, Influencers)
    const TRANSP = ['Correios','Jadlog','Loggi','Sequoia','Azul Cargo'];
    const NAMES = ['João','Maria','Pedro','Ana','Lucas','Carla','Rafa','Beatriz','Paulo','Júlia'];
    let rastreioMock = Array.from({length:200}, ()=>{
        return {nome: `${pick(NAMES)} ${pick(['S.','A.','D.','M.'])}`, rastreio: `NEXT${rand(10000,99999)}BR`, transportadora: pick(TRANSP), data_chegada: fmtBR(addDays(new Date(), rand(-2,7))), status: pick(['Postado','Em Trânsito','Saiu para Entrega','Entregue'])};
    });
    let influencersMock = Array.from({length:50}, (_,i)=>{
        return {nome: `${pick(['Esporte Total','Fit Life','Run Club','Gym Lovers'])} ${i+1}`, tel: `(${rand(11,99)}) 9${rand(1000,9999)}-${rand(1000,9999)}`, cupom: pick(['ESPORTE','FIT','RUN'])+rand(5,25), vendas: rand(10,350), comissao: rand(10,350) * rand(5,20)};
    });
    
    // ==========================
    // Sidebar / Navegação
    // ==========================
    const sidebar = document.getElementById('sidebar');
    const burger = document.getElementById('burger');
    burger.addEventListener('click', () => sidebar.classList.toggle('open'));
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function () {
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.section-container').forEach(sec => sec.classList.remove('active'));
            const target = document.getElementById(`${this.dataset.target}-section`);
            if (target) target.classList.add('active');
            document.getElementById('page-title').textContent = this.textContent;
            sidebar.classList.remove('open');
        });
    });

    // ==========================
    // KPIs + Gráfico 30 dias
    // ==========================
    function renderKPIs() {
        const { faturamento, custoProduto, frete, ads } = baseKPIs;
        const custosVariaveis = custoProduto + frete + ads;
        const margemBruta = faturamento - custosVariaveis;
        const margemPct = (margemBruta / faturamento) * 100;
        const roas = faturamento / ads;

        // Cálculos financeiros com custos operacionais
        const custosOperacionais = custosMock.reduce((total, custo) => total + custo.valor, 0);
        const lucroLiquido = margemBruta - custosOperacionais;
        const lucroPct = (lucroLiquido / faturamento) * 100;
        
        const grid = document.getElementById('kpi-grid');
        grid.innerHTML = `
          <div class="metric-card"><h3>Faturamento (30d)</h3><p>${brl(faturamento)}</p></div>
          <div class="metric-card"><h3>Custos Variáveis</h3><p>${brl(custosVariaveis)}</p><div class="kpi-sub">Produto+Frete+Ads</div></div>
          <div class="metric-card"><h3>Margem Bruta</h3><p>${brl(margemBruta)}</p><div class="kpi-sub">Margem: <b>${pct(margemPct)}</b></div></div>
          <div class="metric-card"><h3>ADS (30d)</h3><p>${brl(ads)}</p><div class="kpi-sub">ROAS: <b>${roas.toFixed(2)}</b></div></div>
          <div class="metric-card"><h3>Custos Operacionais</h3><p>${brl(custosOperacionais)}</p><div class="kpi-sub">Salários, aluguel, etc.</div></div>
          <div class="metric-card"><h3>Lucro Líquido</h3><p class="${lucroLiquido >= 0 ? 'lucro-pos' : 'lucro-neg'}">${brl(lucroLiquido)}</p><div class="kpi-sub">Lucratividade: <b>${pct(lucroPct)}</b></div></div>
        `;
    }

    function renderChart() {
        const ctx = document.getElementById('chartFatAds');
        const labels = Array.from({ length: 30 }, (_, i) => { const d = addDays(new Date(), -29 + i); return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); });
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Faturamento', data: labels.map(() => rand(2500, 9000)), borderColor: '#000000', backgroundColor: 'rgba(0,0,0,0.1)', tension: .3, fill: false },
                    { label: 'ADS', data: labels.map(() => rand(800, 3800)), borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)', tension: .3, fill: false }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }
    
    // ==========================
    // Tabela genérica: sort, paginação
    // ==========================
    function makePager(containerEl, total, current, perPage, onChange){
        containerEl.innerHTML = '';
        if(total === 0) return;
        
        const pages = Math.ceil(total/perPage);
        const perSel = document.createElement('div');
        perSel.className = 'per-page';
        perSel.innerHTML = `<select>${[10,25,50,100].map(n=>`<option value="${n}" ${n===perPage?'selected':''}>${n}/pág</option>`).join('')}</select>`;
        perSel.querySelector('select').addEventListener('change', (e)=> onChange(1, Number(e.target.value)) );
        containerEl.appendChild(perSel);
        
        for(let p=1;p<=pages;p++){
            const b = document.createElement('button');
            b.textContent = p;
            if(p===current) b.classList.add('active');
            b.addEventListener('click', ()=> onChange(p, perPage));
            containerEl.appendChild(b);
        }
    }

    function sortByKey(arr, key, asc=true){
        return [...arr].sort((a,b)=>{
            let va = a[key], vb = b[key];
            if(typeof va === 'string' && va.startsWith('R$')){
                va = Number(va.replace(/[^\d,.-]/g,'').replace('.','').replace(',','.'));
                vb = Number(vb.replace(/[^\d,.-]/g,'').replace('.','').replace(',','.'));
            } else if (typeof va === 'string') {
                va = va.toLowerCase();
                vb = String(vb).toLowerCase();
            }
            if(va<vb) return asc?-1:1; if(va>vb) return asc?1:-1; return 0;
        });
    }

    // ==========================
    // PEDIDOS (KANBAN)
    // ==========================
    const pedidosState = { all: [...pedidosMock], filtered: [...pedidosMock], search: '' };
    const kanbanBoard = document.getElementById('kanban-board');

    function renderKanban() {
        kanbanBoard.innerHTML = '';
        STATUS.forEach(status => {
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.status = status;

            const pedidosDaColuna = pedidosState.filtered.filter(p => p.status === status);

            column.innerHTML = `
                <header>
                    <h3>${status}</h3>
                    <span class="badge warn">${pedidosDaColuna.length}</span>
                </header>
                <div class="kanban-cards"></div>
            `;
            const cardsContainer = column.querySelector('.kanban-cards');

            pedidosDaColuna.forEach(p => {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.draggable = true;
                card.dataset.id = p.id;
                card.innerHTML = `
                    <strong>Pedido #${p.id}</strong>
                    <small>${p.produto}</small>
                `;
                cardsContainer.appendChild(card);
            });
            kanbanBoard.appendChild(column);
        });
        attachKanbanEvents();
    }

    function attachKanbanEvents() {
        const cards = document.querySelectorAll('.kanban-card');
        const columns = document.querySelectorAll('.kanban-column');
        let draggedCard = null;

        cards.forEach(card => {
            card.addEventListener('dragstart', () => {
                draggedCard = card;
                setTimeout(() => card.classList.add('dragging'), 0);
            });
            card.addEventListener('dragend', () => {
                draggedCard.classList.remove('dragging');
                draggedCard = null;
            });
            card.addEventListener('click', () => abrirDetalhePedido(card.dataset.id));
        });

        columns.forEach(column => {
            column.addEventListener('dragover', e => {
                e.preventDefault();
                column.classList.add('drag-over');
            });
            column.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });
            column.addEventListener('drop', e => {
                e.preventDefault();
                column.classList.remove('drag-over');
                if (!draggedCard) return;

                const cardId = draggedCard.dataset.id;
                const newStatus = column.dataset.status;
                const pedido = pedidosState.all.find(p => p.id === cardId);
                if (pedido) {
                    pedido.status = newStatus;
                    renderKanban(); 
                    toast(`Pedido #${cardId} movido para "${newStatus}".`);
                }
            });
        });
    }

    function filtrarPedidos(term) {
        pedidosState.search = term.trim().toLowerCase();
        pedidosState.filtered = pedidosState.all.filter(p =>
            [p.id, p.produto].join(' ').toLowerCase().includes(pedidosState.search)
        );
        renderKanban();
    }

    function abrirDetalhePedido(id) {
        const p = pedidosState.all.find(x => x.id === id);
        if (!p) return toast('Pedido não encontrado.');
        const content = `
            <p><b>ID:</b> #${p.id}</p>
            <p><b>Produto:</b> ${p.produto}</p>
            <p><b>Status Atual:</b> ${p.status}</p>
            <p><b>Rastreio Próprio:</b> ${p.rastreio}</p>
            <hr style="margin:12px 0;opacity:.3"/>
            <p class="muted">Coletando detalhes e etapas da logística…</p>`;
        openModal(`Detalhes do Pedido #${p.id}`, content, [{ label: 'Fechar', variant: 'ghost' }]);
    }
    
    document.getElementById('search-pedidos').addEventListener('input', (e) => filtrarPedidos(e.target.value));
    document.getElementById('btnImport').addEventListener('click', () => toast('Sincronização com Shopify iniciada...'));
    
    // ==========================
    // FINANÇAS (CRUD)
    // ==========================
    function renderCustos() {
        const tbody = document.getElementById('tbody-custos');
        const searchTerm = document.getElementById('search-custos').value.toLowerCase();
        const filtered = custosMock.filter(c => [c.nome, c.categoria].join(' ').toLowerCase().includes(searchTerm));
        
        const total = filtered.reduce((s, c) => s + c.valor, 0);

        tbody.innerHTML = filtered.map(c => `
            <tr>
                <td>${c.nome}</td>
                <td>${c.categoria}</td>
                <td>${brl(c.valor)}</td>
                <td>
                    <button class="action-button btn-ghost" style="padding: 5px 10px;" onclick="window.app.openCustoModal(${c.id})">Editar</button>
                    <button class="action-button btn-err" style="padding: 5px 10px;" onclick="window.app.deleteCusto(${c.id})">Excluir</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('total-custos').textContent = `Total dos Custos Exibidos: ${brl(total)}`;
        renderKPIs(); // Atualiza o board sempre que a tabela de custos for renderizada
    }

    function openCustoModal(id = null) {
        const custo = id ? custosMock.find(c => c.id === id) : null;
        const title = custo ? 'Editar Custo' : 'Adicionar Novo Custo';
        const content = `
            <div class="form-group">
                <label for="custo-nome">Nome do Custo</label>
                <input type="text" id="custo-nome" value="${custo ? custo.nome : ''}" placeholder="Ex: Salário do Designer">
            </div>
            <div class="form-group">
                <label for="custo-categoria">Categoria</label>
                <input type="text" id="custo-categoria" value="${custo ? custo.categoria : ''}" placeholder="Ex: RH">
            </div>
            <div class="form-group">
                <label for="custo-valor">Valor Mensal (R$)</label>
                <input type="number" id="custo-valor" value="${custo ? custo.valor : ''}" placeholder="Ex: 3500.00" step="0.01">
            </div>
        `;
        openModal(title, content, [
            { label: 'Salvar', variant: 'secondary', onClick: () => saveCusto(id) },
            { label: 'Cancelar', variant: 'ghost' }
        ]);
    }

    function saveCusto(id) {
        const nome = document.getElementById('custo-nome').value.trim();
        const categoria = document.getElementById('custo-categoria').value.trim();
        const valor = parseFloat(document.getElementById('custo-valor').value);

        if (!nome || !categoria || isNaN(valor) || valor <= 0) {
            toast('Por favor, preencha todos os campos corretamente.');
            return;
        }

        if (id) { // Editando
            const index = custosMock.findIndex(c => c.id === id);
            if (index > -1) {
                custosMock[index] = { ...custosMock[index], nome, categoria, valor };
            }
        } else { // Adicionando
            custosMock.push({ id: nextCustoId++, nome, categoria, valor });
        }
        renderCustos();
        closeModal();
    }
    
    function deleteCusto(id) {
        const custo = custosMock.find(c => c.id === id);
        if (!custo) return;
        
        openModal(
            'Confirmar Exclusão', 
            `<p>Tem certeza que deseja excluir o custo "<b>${custo.nome}</b>"?</p>`,
            [
                { label: 'Sim, Excluir', variant: 'err', onClick: () => {
                    custosMock = custosMock.filter(c => c.id !== id);
                    renderCustos();
                    closeModal();
                }},
                { label: 'Cancelar', variant: 'ghost' }
            ]
        );
    }
    
    // Anexando funções ao objeto window para acesso no HTML inline
    window.app = { openCustoModal, deleteCusto };

    document.getElementById('search-custos').addEventListener('input', renderCustos);
    document.getElementById('btnAdicionarCusto').addEventListener('click', () => openCustoModal());

    // ==========================
    // RASTREIO INTERNO
    // ==========================
    const rastreioState = { all:[...rastreioMock], filtered:[...rastreioMock], sortKey:'data_chegada', sortAsc:true, page:1, perPage:10 };
    function renderRastreio(){
        const tbody = document.querySelector('#tabela-rastreio-interno tbody');
        rastreioState.filtered = sortByKey(rastreioState.filtered, rastreioState.sortKey, rastreioState.sortAsc);
        const start = (rastreioState.page-1)*rastreioState.perPage;
        const pageItems = rastreioState.filtered.slice(start, start + rastreioState.perPage);
        
        tbody.innerHTML = pageItems.map(r=>`
          <tr>
            <td>${r.nome}</td>
            <td>${r.rastreio}</td>
            <td>${r.transportadora}</td>
            <td>${r.data_chegada}</td>
            <td><span class="badge ${r.status==='Entregue'?'ok':'warn'}">${r.status}</span></td>
          </tr>`).join('');

        makePager(document.getElementById('pag-rastreio'), rastreioState.filtered.length, rastreioState.page, rastreioState.perPage, (p,pp)=>{ rastreioState.page=p; rastreioState.perPage=pp; renderRastreio(); });
    }
    document.getElementById('search-rastreio').addEventListener('input', (e)=>{
        const term = e.target.value.toLowerCase();
        rastreioState.filtered = rastreioState.all.filter(r=> [r.nome,r.rastreio,r.transportadora,r.status].join(' ').toLowerCase().includes(term));
        rastreioState.page = 1; renderRastreio();
    });

    // ==========================
    // INFLUENCERS
    // ==========================
    const influState = { all:[...influencersMock], filtered:[...influencersMock], sortKey:'vendas', sortAsc:false, page:1, perPage:10 };
    function renderInflu(){
        const tbody = document.querySelector('#tabela-influencers tbody');
        influState.filtered = sortByKey(influState.filtered, influState.sortKey, influState.sortAsc);
        const start = (influState.page-1)*influState.perPage;
        const pageItems = influState.filtered.slice(start, start + influState.perPage);
        
        tbody.innerHTML = pageItems.map(i=>`
          <tr>
            <td>${i.nome}</td>
            <td>${i.tel}</td>
            <td>${i.cupom}</td>
            <td>${i.vendas}</td>
            <td>${brl(i.comissao)}</td>
          </tr>`).join('');

        makePager(document.getElementById('pag-influencers'), influState.filtered.length, influState.page, influState.perPage, (p,pp)=>{ influState.page=p; influState.perPage=pp; renderInflu(); });
    }
    document.getElementById('search-influ').addEventListener('input', (e)=>{
        const t = e.target.value.toLowerCase();
        influState.filtered = influState.all.filter(x=> [x.nome,x.cupom].join(' ').toLowerCase().includes(t));
        influState.page = 1; renderInflu();
    });

    // ==========================
    // Boot (Inicialização)
    // ==========================
    function init() {
        renderKPIs();
        renderChart();
        renderKanban();
        renderCustos();
        renderRastreio();
        renderInflu();
    }

    init();
});
</script>
</body>
</html>